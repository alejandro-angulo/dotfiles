#!/bin/bash
# Swaylock wrapper
#
# Performs host-specific actions.
# Relies on hostname to differentiate devices.
#
# Set the `DRY_RUN` variable to see the comamnd that will be ran instead of
# actually running the command (DRY_RUN=1 swaylock-wrapper).
#
# Depends on gammastep: https://gitlab.com/chinstrap/gammastep

HOST=$(cat /etc/hostname)
LOCK_CMD="swaylock $*"

run_if_not_dry_run () {
    if [[ -z "$DRY_RUN" ]]; then
        sh -c "$1"
    else
        echo "$1"
    fi
}

if [[ "$HOST" == "gospel" ]]; then
    # WARNING: Will not work correctly if `-f` flag is set.
    PRE_CMD="hue-cli --ip-address 192.168.113.180 --username HiPM8aSf7IIOOFDikEa3hfh1lx5CXXkLun7Dkf8M groups --id 5 --off"
    POST_CMD="hue-cli --ip-address 192.168.113.180 --username HiPM8aSf7IIOOFDikEa3hfh1lx5CXXkLun7Dkf8M groups --id 5 --on"
    PERIOD=""

    update_period () {
        PERIOD="$(gammastep -p 2>&1 /dev/null | rg Period: | awk '{ print $3 }')"
    }

    update_light () {
        # Expects 1 parameter which should be the command to update the light
        update_period
        if [[ "$PERIOD" != "Daytime" ]]; then
            # Don't bother toggling the light if it's not dark out.
            run_if_not_dry_run "$1"
        fi
    }

    update_light "$PRE_CMD"
    run_if_not_dry_run "$LOCK_CMD"
    lock_return="$?"
    if [[ $lock_return -eq 0 ]]; then
        update_light "$POST_CMD"
    fi
else
    run_if_not_dry_run "$LOCK_CMD"
fi
